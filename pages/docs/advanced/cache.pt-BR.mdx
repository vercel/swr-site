import Callout from 'nextra-theme-docs/callout'

# Cache

<Callout>
    Atualize para a √∫ltima vers√£o (‚â• 1.0.0) para usar este recurso.
</Callout>

<Callout emoji="‚ö†Ô∏è">

Na maioria dos casos, voc√™ n√£o deve escrever diretamente no cache, o que pode causar comportamentos indefinidos do SWR. Se voc√™ precisa mutar manualmente uma chave, por favor, considere usar os APIs do SWR.<br />
Veja tamb√©m: [Muta√ß√£o](/docs/mutation), [Redefinir Cache Entre Casos de Teste](#redefinir-cache-entre-casos-de-teste).

</Callout>

Por padr√£o, SWR usa um cache global para armazenar e compartilhar dados entre todos os componentes. Mas voc√™ pode customizar este comportamento com a op√ß√£o `provider` do `SWRConfig`.

Provedores de cache s√£o destinados a permitir SWR com armazenamentos mais personalizados.

## Provedor de Cache

Um provedor de cache √© um objeto (parecido com um Map) que corresponde √† defini√ß√£o de tipo TypeScript da seguinte defini√ß√£o (que pode ser importado de `swr`):

```typescript
interface Cache<Data> {
  get(key: string): Data | undefined
  set(key: string, value: Data): void
  delete(key: string): void
}
```

Por exemplo, um [Map do JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) pode ser usado diretamente como o provedor de cache para SWR.

## Criar Provedor de Cache

A op√ß√£o `provider` do `SWRConfig` recebe uma fun√ß√£o que retorna um [cache-provider](#provedor-de-cache). O provedor ser√° usado por todos os hooks SWR dentro dos limites de configura√ß√£o do `SWRConfig`. Por exemplo:

```jsx
import useSWR, { SWRConfig } from 'swr'

function App() {
  return (
    <SWRConfig value={{ provider: () => new Map() }}>
      <Page/>
    </SWRConfig>
  )
}
```

Todos os hooks SWR dentro de `<Page/>` ler√£o e escrever√£o naquela inst√¢ncia Map. Voc√™ tamb√©m pode usar outras implementa√ß√µes de provedor de cache para seu caso espec√≠fico.

<Callout>
    No exemplo acima, quando o componente `<App/>` √© re-montado, o provedor tamb√©m √© re-criado. Provedores de cache devem ser colocados mais alto na √°rvore de componentes, ou fora do render.
</Callout>

import { Cache } from 'components/diagrams/cache'

<div className="my-8">
  <Cache/>
</div>

Quando aninhado, hooks SWR ir√£o usar o provedor de cache mais alto. Se n√£o houver provedor de cache mais alto, ele ir√° usar o provedor padr√£o, que √© um `Map` vazio.

<Callout emoji="‚ö†Ô∏è">
    Se um provedor de cache √© usado, o `mutate` global **n√£o** funcionar√° para os hooks SWR dentro do limite de configura√ß√£o `<SWRConfig>`. Por favor, use [isto](#acessar-provedor-de-cache-atual) em vez disso.
</Callout>

## Acessar Provedor de Cache Atual

Quando dentro de um Componente React, voc√™ precisa usar o [`useSWRConfig`](/docs/global-configuration#acesso-√†s-configura√ß√µes-globais) hook para obter acesso ao provedor de cache atual e outras configura√ß√µes, incluindo `mutate`:

```jsx
import { useSWRConfig } from 'swr'

function Avatar() {
  const { cache, mutate, ...extraConfig } = useSWRConfig()
  // ...
}
```

Se n√£o estiver sob nenhum `<SWRConfig>`, retornar√° as configura√ß√µes padr√£o.

## Experimental: Estender o Provedor de Cache

<Callout emoji="üß™">
   Este √© um recurso experimental, o comportamento pode mudar em futuras atualiza√ß√µes.
</Callout>

Quando v√°rios componentes `<SWRConfig>` s√£o aninhados, o provedor de cache pode ser estendido.

O primeiro argumento para a fun√ß√£o `provider` √© o provedor de cache do n√≠vel superior `<SWRConfig>` (ou o cache padr√£o se n√£o houver `<SWRConfig>` pai), voc√™ pode us√°-lo para estender o provedor de cache:

```jsx
<SWRConfig value={{ provider: (cache) => newCache }}>
  ...
</SWRConfig>
```

## Exemplos

### Mudar V√°rias Chaves do RegEx

Com a flexibilidade da API do provedor de cache, voc√™ pode at√© criar um auxiliar de "muta√ß√£o parcial".

No exemplo abaixo, `matchMutate` pode receber uma express√£o regex como chave e ser usada para alterar aqueles que corresponderam a esse padr√£o.

```js
function useMatchMutate() {
  const { cache, mutate } = useSWRConfig()
  return (matcher, ...args) => {
    if (!(cache instanceof Map)) {
      throw new Error('matchMutate requires the cache provider to be a Map instance')
    }

    const keys = []

    for (const key of cache.keys()) {
      if (matcher.test(key)) {
        keys.push(key)
      }
    }

    const mutations = keys.map((key) => mutate(key, ...args))
    return Promise.all(mutations)
  }
}
```

Em seguida, dentro do seu componente:

```jsx
function Button() {
  const matchMutate = useMatchMutate()
  return <button onClick={() => matchMutate(/^\/api\//)}>
    Revalidate all keys start with "/api/"
  </button>
}
```

<Callout>
  Observe que este exemplo requer que o provedor de cache seja uma inst√¢ncia Map.
</Callout>

### Cache Persistente Baseado em LocalStorage

Voc√™ pode querer sincronizar seu cache com `localStorage`. Aqui est√° um exemplo de implementa√ß√£o:

```jsx
function localStorageProvider() {
  // Ao inicializar, restauramos os dados de `localStorage` em um mapa.
  const map = new Map(JSON.parse(localStorage.getItem('app-cache') || '[]'))

  // Antes de descarregar o aplicativo, gravamos todos os dados em `localStorage`.
  window.addEventListener('beforeunload', () => {
    const appCache = JSON.stringify(Array.from(map.entries()))
    localStorage.setItem('app-cache', appCache)
  })

  // Ainda usamos o mapa para grava√ß√£o e leitura para desempenho.
  return map
}
```

Em seguida, use-o como provedor:

```jsx
<SWRConfig value={{ provider: localStorageProvider }}>
  <App/>
</SWRConfig>
```

<Callout>
  Como melhoria, voc√™ tamb√©m pode usar o cache de mem√≥ria como um buffer e gravar em `localStorage` periodicamente. Voc√™ tamb√©m pode implementar um cache em camadas semelhante com IndexedDB ou WebSQL.
</Callout>

### Redefinir Cache Entre Casos de Teste

Ao testar seu aplicativo, talvez voc√™ queira redefinir o cache SWR entre os casos de teste. Voc√™ pode simplesmente envolver seu aplicativo com um provedor de cache vazio. Aqui est√° um exemplo com Jest:

```jsx
describe('test suite', async () => {
  it('test case', async () => {
    render(
      <SWRConfig value={{ provider: () => new Map() }}>
        <App/>
      </SWRConfig>
    )
  })
})
```

### Acesso ao Cache

Alerta: voc√™ n√£o deve gravar diretamente no cache, isso pode causar um comportamento indefinido.

```jsx
const { cache } = useSWRConfig()

cache.get(key) // Obt√©m os dados atuais para uma chave.
cache.clear() // ‚ö†Ô∏è Limpa todo o cache. O SWR ser√° revalidado ap√≥s a re-renderiza√ß√£o.
```
