import { Callout } from 'nextra-theme-docs'

# Cache

<Callout>
  Mettre √† jour vers la derni√®re version (‚â• 1.0.0) pour utiliser cette fonctionnalit√©.
</Callout>

<Callout emoji="‚ö†Ô∏è">
  Dans la plupart des cas, vous ne devriez pas √©crire directement dans le cache, ce qui peut entra√Æner des comportements ind√©finis de SWR. Si vous avez besoin de muter manuellement une cl√©, veuillez envisager d'utiliser les API SWR.<br/>
  A voir aussi: [Mutation](/docs/mutation), [R√©initialisation du Cache entre les tests](#reset-cache-between-test-cases).
</Callout>

Par d√©faut, SWR utilise un cache global pour stocker et partager les donn√©es entre tous les composants. Mais vous pouvez √©galement personnaliser ce comportement avec l'option `provider` de `SWRConfig`.

Les fournisseurs de cache sont destin√©s √† permettre SWR avec des stockages plus personnalis√©s.

## Fournisseur de Cache [#cache-provider]

Un fournisseur de cache est un objet de type Map qui correspond √† la d√©finition TypeScript suivante (qui peut √™tre import√©e depuis `swr`):

```typescript
interface Cache<Data> {
  get(key: string): Data | undefined
  set(key: string, value: Data): void
  delete(key: string): void
  keys(): IterableIterator<string>
}
```

Par exemple, une instance de [JavaScript Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) peut √™tre directement utilis√©e comme fournisseur de cache pour SWR.

## Creation du Fournisseur de Cache [#create-cache-provider]

L'option `provider` de `SWRConfig` re√ßoit une fonction qui renvoie un [fournisseur de cache](#cache-provider). Le fournisseur sera ensuite utilis√© par tous les hooks SWR √† l'int√©rieur de cette limite `SWRConfig`. Par exemple:

```jsx
import useSWR, { SWRConfig } from 'swr'

function App() {
  return (
    <SWRConfig value={{ provider: () => new Map() }}>
      <Page/>
    </SWRConfig>
  )
}
```

Tous les hooks SWR √† l'int√©rieur de `<Page/>` liront et √©criront √† partir de cette instance de Map. Vous pouvez √©galement utiliser d'autres impl√©mentations de fournisseurs de cache pour votre cas d'utilisation sp√©cifique.

<Callout>
  Dans l'exemple ci-dessus, lorsque le composant `<App/>` est remont√©, le fournisseur sera √©galement recr√©√©. Les fournisseurs de cache doivent √™tre plac√©s plus haut dans l'arbre de composants, ou en dehors du rendu.
</Callout>

import { Cache } from 'components/diagrams/cache'

<div className="my-8">
  <Cache/>
</div>

Lorsqu'ils sont imbriqu√©s, les hooks SWR utiliseront le fournisseur de cache de niveau sup√©rieur. S'il n'y a pas de fournisseur de cache de niveau sup√©rieur, il se replie sur le fournisseur de cache par d√©faut, qui est une `Map` vide.

<Callout emoji="‚ö†Ô∏è">
  Si un fournisseur de cache est utilis√©, le `mutate` global ne fonctionnera **pas** pour les hooks SWR sous cette limite `<SWRConfig>`. Veuillez utiliser [celui-ci](#access-current-cache-provider) √† la place.
</Callout>

## Acc√®s au Fournisseur de Cache Actuel [#access-current-cache-provider]

Lorsqu'il est √† l'int√©rieur d'un composant React, vous devez utiliser le hook [`useSWRConfig`](/docs/global-configuration#access-to-global-configurations) pour acc√©der au fournisseur de cache actuel ainsi qu'√† d'autres configurations, y compris `mutate`:

```jsx
import { useSWRConfig } from 'swr'

function Avatar() {
  const { cache, mutate, ...extraConfig } = useSWRConfig()
  // ...
}
```

Si il n'est pas sous une limite `<SWRConfig>`, il renverra les configurations par d√©faut.

## Experimental: Etendre le Fournisseur de Cache [#experimental-extend-cache-provider]

<Callout emoji="üß™">
  Ceci est une fonctionnalit√© exp√©rimentale, le comportement pourrait changer dans les futures mises √† jour.
</Callout>

Lorsque plusieurs composants `<SWRConfig>` sont imbriqu√©s, le fournisseur de cache peut √™tre √©tendu.

Le premier argument de la fonction `provider` est le fournisseur de cache de la limite `<SWRConfig>` de niveau sup√©rieur (ou le cache par d√©faut s'il n'y a pas de limite `<SWRConfig>` parent), vous pouvez l'utiliser pour √©tendre le fournisseur de cache:

```jsx
<SWRConfig value={{ provider: (cache) => newCache }}>
  ...
</SWRConfig>
```

## Exemples [#examples]

### Cache Persistant Bas√© sur le LocalStorage [#localstorage-based-persistent-cache]

Vous pouvez synchroniser votre cache avec `localStorage`. Voici un exemple d'impl√©mentation:

```jsx
function localStorageProvider() {
  // When initializing, we restore the data from `localStorage` into a map.
  const map = new Map(JSON.parse(localStorage.getItem('app-cache') || '[]'))

  // Before unloading the app, we write back all the data into `localStorage`.
  window.addEventListener('beforeunload', () => {
    const appCache = JSON.stringify(Array.from(map.entries()))
    localStorage.setItem('app-cache', appCache)
  })

  // We still use the map for write & read for performance.
  return map
}
```

Then use it as a provider:

```jsx
<SWRConfig value={{ provider: localStorageProvider }}>
  <App/>
</SWRConfig>
```

<Callout>
  As an improvement, you can also use the memory cache as a buffer, and write to `localStorage` periodically. You can also implement a similar layered cache with IndexedDB or WebSQL.
</Callout>

### Reset Cache Between Test Cases [#reset-cache-between-test-cases]

When testing your application, you might want to reset the SWR cache between test cases. You can simply wrap your application with an empty cache provider. Here's an example with Jest:

```jsx
describe('test suite', async () => {
  it('test case', async () => {
    render(
      <SWRConfig value={{ provider: () => new Map() }}>
        <App/>
      </SWRConfig>
    )
  })
})
```

### Modify the Cache Data [#modify-the-cache-data]

<Callout emoji="üö®" type="error">
  You should not write to the cache directly, it might cause undefined behavior.
</Callout>

You can use [`mutate`](/docs/mutation) to modify the cache. For example, you can clear all cache data like the following.

```jsx
const { mutate } = useSWRConfig()

mutate(
  key => true, // which cache keys are updated
  undefined, // update cache data to `undefined`
  { revalidate: false } // do not revalidate
)
```

More information can be found [here](/docs/arguments#multiple-arguments).
