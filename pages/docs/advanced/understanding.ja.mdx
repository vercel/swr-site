import Video from 'components/video'

# SWR を理解する

## 状態機械

`useSWR` は `data`、`error`、`isLoading` と `isValidating` を `fetcher` 関数の状態に応じて返します。これらの図は SWR がそれぞれでどのように値を返すのかを示しています。

### フェッチして再検証する

これはフェッチして再検証するパターンです。

![フェッチと再検証のパターン](/img/understanding/fetch-and-revalidate.svg)

### キーの変更

これはフェッチした後にキーを変更し、さらにその後再検証するパターンです。

![キーが変更されたパターン](/img/understanding/key-change.svg)

### キーの変更と以前のデータ

これはフェッチした後にキーを変更し再検証するのを `keepPreviousData` オプション付きで行うパターンです。

![キーの変更を keepPreviousData オプションありで行うパターン](/img/understanding/key-change-previous-data.svg)

### フォールバック

これはフェッチした後に再検証するのをフォールバックデータと一緒に行うパターンです。

![フォールバックのパターン](/img/understanding/fallback.svg)

### キーの変更とフォールバック

これはフェッチした後にキーを変更し再検証するのをフォールバックデータと一緒に行うパターンです。

![キーの変更をフォールバックありで行うパターン](/img/understanding/key-change-fallback.svg)

### キーの変更と以前のデータとフォールバック

これはフェッチした後にキーを変更し再検証するのを `keepPreviousData` オプションとフォールバックデータと一緒に行うパターンです。

![キーの変更を keepPreviousData オプションとフォールバックありで行うパターン](/img/understanding/key-change-previous-data-fallback.svg)

## よりよいユーザー体験のために以前のデータを返す

キー入力に応じたリアルタイム検索など継続的なユーザーアクションをベースにしたデータ取得を行う時、以前のデータを維持することによりユーザー体験を改善できます。`keepPreviousData` はこれを可能にするオプションです。これはシンプルな検索の例です。

```jsx
function Search() {
  const [search, setSearch] = React.useState('');

  const { data, isLoading } = useSWR(`/search?q=${search}`, fetcher, {
    keepPreviousData: true
  });

  return (
    <div>
      <input
        type="text"
        value={search}
        onChange={(e) => setSearch(e.target.value)}
        placeholder="Search..."
      />

      <div className={isLoading ? "loading" : ""}>
        {data?.products.map(item => <Product key={item.id} name={item.name} />)
      </div>
    </div>
  );
}
```

`keepPreviousData` が有効にされている場合、SWR のキーが変わり新しいデータの取得が開始された場合にも以前のキーに対応するデータが返されます。

<Video
  src="https://user-images.githubusercontent.com/3676859/163695903-a3eb1259-180e-41e0-821e-21c320201194.mp4"
  caption="ビデオ: keepPreviousData が有効な場合には以前の検索結果が維持されます"
  ratio={640/730}
/>

## パフォーマンのための依存収集

SWR はコンポーネントで使われているデータが更新された場合のみ再レンダリングします。コンポーネントの中で `data` しか使っていない場合、SWR は `isValidating` や `isLoading` のプロパティの更新を無視します。これはレンダリングの回数を減らします。詳細については [こちら](/docs/advanced/performance#dependency-collection)。
